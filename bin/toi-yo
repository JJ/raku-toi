#!/usr/bin/env raku

# Example telegram bot that uses the module for checking in

use Telegram; # remember to zef install Telegram
use Toi;
use Toi::Data::YAML;

sub MAIN( $file-name = "toi.yaml" ) {

    say "Usando $file-name para almacenar check-ins";
    die "No token" unless %*ENV<TOI_BOT_TOKEN>;
    my $bot = Telegram::Bot.new(%*ENV<TOI_BOT_TOKEN>);
    my $data = Toi::Data::YAML.new;
    my $toi = Toi.new: :$data;
    $bot.start(1);
    react {
        whenever $bot.messagesTap -> $msg {
            $msg.text ~~ /\/$<command> = (\w+) \h* $<args> = (.*)/;
            say $msg.raku, " → ",  $<command>;
            given $<command> {
                when "toi" {
                    my $nombre = $<args>.words.join(" ");
                    $toi.check-in($msg.sender.username, $nombre );
                    $bot.sendMessage($msg.chat.id,
                                     "✓ \@{$msg.sender.username} asiste como «$nombre»" ) ;
                }
                when "about" {
                    $bot.sendMessage($msg.chat.id, q:to/EOM/);
Para registrarte, usa /toi Nombre
EOM
                }
            }
        }
        whenever signal(SIGINT) {
            $bot.stop;
            exit;
        }
    }
}
